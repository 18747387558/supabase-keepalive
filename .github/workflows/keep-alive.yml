name: Supabase Keep-Alive

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 å’Œ 12:00 è¿è¡Œ
    - cron: '0 0,12 * * *'
    
    # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 */6 * * *'
  
  # æ‰‹åŠ¨è§¦å‘å™¨
  workflow_dispatch:
    inputs:
      log_level:
        description: 'æ—¥å¿—çº§åˆ«'
        required: false
        default: 'info'
  
  # æ¨é€ä»£ç æ—¶ä¹Ÿè¿è¡Œï¼ˆæµ‹è¯•ç”¨ï¼‰
  push:
    branches: [ main, master ]
    paths:
      - 'scripts/**'
      - '.github/workflows/**'
      - 'package.json'

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“š æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: â” è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "å¼€å§‹å®‰è£…ä¾èµ–..."
          npm install
          echo "ä¾èµ–å®‰è£…å®Œæˆ"
          
      - name: ğŸ”¨ ç¼–è¯‘ TypeScript
        run: |
          echo "ç¼–è¯‘ TypeScript..."
          npx tsc --version
          npm run build
          echo "ç¼–è¯‘å®Œæˆ"
          
      - name: ğŸ§ª æµ‹è¯•è„šæœ¬
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: |
          echo "æµ‹è¯•ç¯å¢ƒå˜é‡..."
          echo "URL å‰10ä½: ${NEXT_PUBLIC_SUPABASE_URL:0:10}"
          
      - name: ğŸš€ è¿è¡Œä¿æ´»è„šæœ¬
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: |
          echo "å¼€å§‹è¿è¡Œä¿æ´»è„šæœ¬..."
          echo "å½“å‰æ—¶é—´: $(date)"
          echo "ç¯å¢ƒå˜é‡å·²è®¾ç½®: $([ -n \"$NEXT_PUBLIC_SUPABASE_URL\" ] && echo \"æ˜¯\" || echo \"å¦\")"
          
          # è¿è¡Œä¿æ´»è„šæœ¬
          cd scripts
          node keep-alive.js
          
      - name: âœ… éªŒè¯æ‰§è¡Œç»“æœ
        if: always()
        run: |
          echo "ä¿æ´»ä»»åŠ¡æ‰§è¡Œå®Œæˆ"
          echo "æ‰§è¡Œæ—¶é—´: $(date)"
          echo "ä½œä¸šçŠ¶æ€: ${{ job.status }}"
